/*
0x28 0x00                               ; length prefix, the next 40 bytes are all vendor specific configuration + CRC
0x00 0xff 0x01 0xff 0x02 0xff 0x03 0xff ; set pci subsystem vendor / subsystem to 0xff ff ff ff
0x0c 0x00 0x0d 0x00 0x0e 0x00 0x0f 0x00 ; set PHY control 0 to 0x00 - undocumented HW init
0x10 0x00 0x11 0x00 0x12 0x00 0x13 0x00 ; set PHY control 1 to 0x00 - undocumented HW init - may break uPD720202
0x14 0x00 0x15 0x00                     ; PHY control 2, battery charging SDP only
0x16 0x03                               ; PHY control 2, Tr/Tf fine control, default value - uPD720202 has a different default
0x17 0x00                               ; PHY control 2, HW init
0x18 0x00 0x19 0x00 0x1a 0x01 0x1b 0x05 ; host configuration register, default values
0xd0 0xa6                               ; CRC16
*/

#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>

const uint8_t test[42] = {
        0x28, 0x00, 0x00, 0xff, 0x01, 0xff, 0x02, 0xff, 0x03, 0xff, 0x0c, 0x00, 0x0d, 0x00, 0x0e, 0x00,
        0x0f, 0x00, 0x10, 0x00, 0x11, 0x00, 0x12, 0x00, 0x13, 0x00, 0x14, 0x00, 0x15, 0x00, 0x16, 0x03,
        0x17, 0x00, 0x18, 0x00, 0x19, 0x00, 0x1a, 0x01, 0x1b, 0x05
};

const uint16_t crc_table[16] = {
        0x0000,   0x1081,   0x2102,   0x3183,   0x4204,   0x5285,   0x6306,   0x7387,
        0x8408,   0x9489,   0xA50A,   0xB58B,   0xC60C,   0xD68D,  0xE70E,   0xF78F,
};

uint16_t crc_update(uint16_t crc, uint8_t *data, int len)
{
        uint16_t c = crc ^ 0xffff;
        for(int n = 0; n < len; n++) {
                uint8_t m = data[n];
                c = crc_table[(c ^ m) & 0xf] ^ (c >> 4);
                c = crc_table[(c ^ (m >> 4)) & 0xf] ^ (c >> 4);
        }
        return c ^ 0xffff;
}

int main(int argc, char **argv) {
  uint16_t crc = crc_update(0, &test, 42);
  printf("0x%02x 0x%02x\n", (crc & 0xff), (crc >> 8));
  exit(0);
}
